--- origsrc/samtools-1.22.1/Makefile	2025-07-14 20:11:10.000000000 +0900
+++ src/samtools-1.22.1/Makefile	2025-09-16 10:52:47.111916300 +0900
@@ -30,11 +30,6 @@ CFLAGS   = -g -Wall -O2
 LDFLAGS  =
 LIBS     =
 
-LZ4DIR   = ./lz4
-LZ4_CPPFLAGS = -I$(LZ4DIR)
-LZ4_LDFLAGS  = -L$(LZ4DIR)
-
-
 AOBJS=      bam_aux.o bam_index.o bam_plcmd.o sam_view.o bam_fastq.o \
             bam_cat.o bam_md.o bam_plbuf.o bam_reheader.o bam_sort.o \
             bam_rmdup.o bam_rmdupse.o bam_mate.o bam_stat.o bam_color.o \
@@ -46,7 +41,6 @@ AOBJS=      bam_aux.o bam_index.o bam_pl
             bam_ampliconclip.o amplicon_stats.o bam_import.o bam_samples.o \
             bam_consensus.o consensus_pileup.o reference.o reset.o cram_size.o \
             bam_checksum.o
-LZ4OBJS  =  $(LZ4DIR)/lz4.o
 
 prefix      = /usr/local
 exec_prefix = $(prefix)
@@ -94,7 +88,7 @@ all: $(PROGRAMS) $(MISC_PROGRAMS) $(TEST
 
 ALL_CPPFLAGS = -I. $(HTSLIB_CPPFLAGS) $(LZ4_CPPFLAGS) $(CPPFLAGS)
 ALL_LDFLAGS  = $(HTSLIB_LDFLAGS) $(LZ4_LDFLAGS) $(LDFLAGS)
-ALL_LIBS     = -lz $(LIBS)
+ALL_LIBS     = -lz $(LIBS) $(LZ4_LIBS)
 
 # Usually config.mk and config.h are generated by running configure
 # or config.status, but if those aren't used create defaults here.
@@ -142,8 +136,8 @@ print-version:
 LIBST_OBJS = sam_opts.o sam_utils.o bedidx.o bam.o
 
 
-samtools: $(AOBJS) $(LZ4OBJS) libst.a $(HTSLIB)
-	$(CC) $(ALL_LDFLAGS) -o $@ $(AOBJS) $(LZ4OBJS) libst.a $(HTSLIB_LIB) $(CURSES_LIB) -lm $(ALL_LIBS) -lpthread
+samtools: $(AOBJS) libst.a $(HTSLIB)
+	$(CC) $(ALL_LDFLAGS) -o $@ $(AOBJS) libst.a $(HTSLIB_LIB) $(CURSES_LIB) -lm $(ALL_LIBS) -lpthread
 
 # For building samtools and its test suite only: NOT to be installed.
 libst.a: $(LIBST_OBJS)
@@ -164,7 +158,7 @@ sam_utils_h = sam_utils.h $(htslib_khash
 sample_h = sample.h $(htslib_kstring_h)
 samtools_h = samtools.h $(htslib_hts_defs_h) $(htslib_sam_h) $(sam_utils_h)
 stats_isize_h = stats_isize.h $(htslib_khash_h)
-tmp_file_h = tmp_file.h $(htslib_sam_h) $(LZ4DIR)/lz4.h
+tmp_file_h = tmp_file.h $(htslib_sam_h)
 
 bam.o: bam.c config.h $(bam_h) $(htslib_kstring_h)
 bam2bcf.o: bam2bcf.c config.h $(htslib_hts_h) $(htslib_sam_h) $(bam2bcf_h)
@@ -240,7 +234,7 @@ check test: samtools $(BGZIP) $(TEST_PRO
 	test/split/test_expand_format_string
 	test/split/test_filter_header_rg
 	test/split/test_parse_args
-	REF_PATH=: test/test.pl --exec bgzip=$(BGZIP) $${TEST_OPTS:-}
+	REF_PATH=: test/test.pl --exec bgzip=$(BGZIP) bin=. $${TEST_OPTS:-}
 	test/merge/test_bam_translate test/merge/test_bam_translate.tmp
 	test/merge/test_rtrans_build
 	test/merge/test_trans_tbl_init
@@ -340,7 +334,7 @@ testclean:
 	-cd test/reference && rm -f mpileup.*.fai
 
 mostlyclean: testclean
-	-rm -f *.o misc/*.o test/*.o test/*/*.o version.h $(LZ4OBJS)
+	-rm -f *.o misc/*.o test/*.o test/*/*.o version.h
 
 clean: mostlyclean
 	-rm -f $(PROGRAMS) libst.a $(MISC_PROGRAMS) $(TEST_PROGRAMS)
--- origsrc/samtools-1.22.1/bam_consensus.c	2025-07-14 20:11:10.000000000 +0900
+++ src/samtools-1.22.1/bam_consensus.c	2025-09-16 10:39:59.233868200 +0900
@@ -146,6 +146,10 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBI
 #include "bam_plbuf.h"
 #include "consensus_pileup.h"
 
+#if defined(_P)
+#undef _P
+#endif
+
 #ifdef __SSE__
 #   include <xmmintrin.h>
 #else
--- origsrc/samtools-1.22.1/config.mk.in	2025-07-14 20:11:10.000000000 +0900
+++ src/samtools-1.22.1/config.mk.in	2025-09-16 10:28:06.060240800 +0900
@@ -53,3 +53,7 @@ HTSLIB_CPPFLAGS = @HTSLIB_CPPFLAGS@
 @Hinstall@HTSLIB_LIB = -lhts
 
 CURSES_LIB = @CURSES_LIB@
+
+LZ4_CPPFLAGS = @LZ4_CPPFLAGS@
+LZ4_LDFLAGS = @LZ4_LDFLAGS@
+LZ4_LIBS = @LZ4_LIBS@
--- origsrc/samtools-1.22.1/configure.ac	2025-07-14 20:11:10.000000000 +0900
+++ src/samtools-1.22.1/configure.ac	2025-09-16 10:28:31.079082100 +0900
@@ -144,5 +144,10 @@ esac
 dnl Apply value from HTS_PROG_CC_WERROR (if set)
 AS_IF([test "x$hts_late_cflags" != x],[CFLAGS="$CFLAGS $hts_late_cflags"])
 
+PKG_CHECK_MODULES([LZ4], [liblz4])
+AC_SUBST([LZ4_CPPFLAGS])
+AC_SUBST([LZ4_LDFLAGS])
+AC_SUBST([LZ4_LIBS])
+
 AC_CONFIG_FILES([config.mk])
 AC_OUTPUT
--- origsrc/samtools-1.22.1/test/test.pl	2025-07-14 20:11:10.000000000 +0900
+++ src/samtools-1.22.1/test/test.pl	2025-09-16 10:54:21.857026900 +0900
@@ -114,7 +114,7 @@ sub error
 sub tempfile {
     my ($fh, $name) = File::Temp::tempfile(@_);
     if (wantarray) {
-        if ($^O =~ /^(?:cygwin|msys|MSWin32)/) {
+        if ($^O =~ /^(?:msys|MSWin32)/) {
             $name = abs_path($name);
         }
         return ($fh, $name);
@@ -132,7 +132,7 @@ sub cygpath {
 sub tempdir
 {
     my $dir = File::Temp::tempdir(@_);
-    if ($^O =~ /^(cygwin|msys)/) {
+    if ($^O =~ /^(msys)/) {
         $dir = cygpath($dir);
     } elsif ($^O eq 'MSWin32') {
         $dir =~ s/\\/\//g;
@@ -142,7 +142,7 @@ sub tempdir
 
 sub parse_params
 {
-    my $opts = { bgzip=>"bgzip", keep_files=>0, nok=>0, nfailed=>0, nxfail => 0, nxpass => 0 };
+    my $opts = { bgzip=>"bgzip", keep_files=>0, nok=>0, nfailed=>0, nxfail => 0, nxpass => 0, bin => '.' };
     my $help;
     Getopt::Long::Configure('bundling');
     my $ret = GetOptions (
@@ -160,10 +160,10 @@ sub parse_params
     if ( !$ret or $help ) { error(); }
     $$opts{tmp}  = $$opts{keep_files} ? $$opts{keep_files} : tempdir(CLEANUP => 1);
     $$opts{path} = $FindBin::RealBin;
-    $$opts{bin}  = $FindBin::RealBin;
-    if ($^O =~ /^(cygwin|msys)/) {
+    # $$opts{bin}  = $FindBin::RealBin;
+    if ($^O =~ /^(msys)/) {
         $$opts{path} = cygpath($$opts{path});
-        $$opts{bin}  = cygpath($$opts{bin});
+        # $$opts{bin}  = cygpath($$opts{bin});
     }
     $$opts{bin}  =~ s{/test/?$}{};
     if ( $$opts{keep_files} ) { cmd("mkdir -p $$opts{keep_files}"); }
@@ -171,7 +171,7 @@ sub parse_params
     {
         $SIG{TERM} = $SIG{INT} = sub { clean_files($opts); };
     }
-    $$opts{diff} = "diff" . ($^O =~ /^(?:cygwin|msys|MSWin32)/ ? " -b":"");
+    $$opts{diff} = "diff" . ($^O =~ /^(?:msys|MSWin32)/ ? " -b":"");
     return $opts;
 }
 sub clean_files
@@ -941,7 +941,7 @@ sub test_mpileup
         cmd("$$opts{bin}/samtools index $$opts{tmp}/$file.cram");
         print $fh1 "$$opts{tmp}/$file.bam\n";
         print $fh2 "$$opts{tmp}/$file.cram\n";
-        my $atmp = $^O =~ /^(cygwin|msys)/ ? cygpath($$opts{tmp}) : abs_path($$opts{tmp});
+        my $atmp = $^O =~ /^(msys)/ ? cygpath($$opts{tmp}) : abs_path($$opts{tmp});
         unless ($atmp =~ /^\//) { $atmp = "/$atmp"; }
         print $fh3 "file://$atmp/$file.bam\n";
         print $fh4 "file://$atmp/$file.cram\n";
@@ -1030,7 +1030,7 @@ sub test_usage
         next if ($subcommand =~ /^(help|version)$/);
         # Under msys the isatty function fails to recognise the terminal.
         # Skip these tests for now.
-        next if ($^O =~ /^(cygwin|msys)/ && $subcommand =~ /^(dict|sort|stats|view|fasta|fastq|samples|reference|head)$/);
+        next if ($^O =~ /^(msys)/ && $subcommand =~ /^(dict|sort|stats|view|fasta|fastq|samples|reference|head)$/);
         test_usage_subcommand($opts,%args,subcmd=>$subcommand);
     }
 }
@@ -3284,7 +3284,7 @@ sub test_stats
 {
     my ($opts,%args) = @_;
 
-    my $efix = ($^O =~ /^(?:cygwin|msys|MSWin32)$/) ? 1 : 0;
+    my $efix = ($^O =~ /^(?:msys|MSWin32)$/) ? 1 : 0;
 
     test_cmd($opts,out=>'stat/1.stats.expected',cmd=>"$$opts{bin}/samtools stats -r $$opts{path}/stat/test.fa $$opts{path}/stat/1_map_cigar.sam | tail -n+4", exp_fix=>$efix);
     test_cmd($opts,out=>'stat/1.stats.large.expected',cmd=>"$$opts{bin}/samtools stats $$opts{path}/stat/1_map_cigar_large.sam | tail -n+4", exp_fix=>$efix);
